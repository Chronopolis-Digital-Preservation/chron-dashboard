.review_context:
  only:
    refs:
      - merge_requests

deploy_review:
  stage: deploy
  extends:
    - .auto-deploy
    - .review_context
  environment:
    name: review/$CI_MERGE_REQUEST_ID
    url: http://dashboard-$CI_MERGE_REQUEST_ID.$REVIEW_DOMAIN
    on_stop: cleanup_review
    auto_stop_in: 1 week
  variables:
    APP_HOST: dashboard-$CI_MERGE_REQUEST_ID.$REVIEW_DOMAIN
    AUTH_METHOD: developer
    DEPLOY_TAG: $CI_COMMIT_SHA
    HELM_RELEASE_NAME: dashboard-$CI_MERGE_REQUEST_ID
    KUBE_NAMESPACE: $KUBE_NAMESPACE_REVIEW

cleanup_review:
  stage: deploy
  when: manual
  extends:
    - .auto-deploy
    - .review_context
  environment:
    name: review/$CI_MERGE_REQUEST_ID
    url: http://dashboard-$CI_MERGE_REQUEST_ID.$REVIEW_DOMAIN
    action: stop
  variables:
    APP_HOST: dashboard-$CI_MERGE_REQUEST_ID.$REVIEW_DOMAIN
    DEPLOY_TAG: $CI_COMMIT_SHA
    GIT_STRATEGY: none
    HELM_RELEASE_NAME: dashboard-$CI_MERGE_REQUEST_ID
    KUBE_NAMESPACE: $KUBE_NAMESPACE_REVIEW
  script:
    - delete
    - delete_stateful_set_pvcs

